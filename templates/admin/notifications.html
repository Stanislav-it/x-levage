{% extends "base.html" %}
{% set title = "Admin — powiadomienia" %}

{% block content %}
<section class="max-w-6xl mx-auto px-4 pt-10 pb-6">
  <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6">
    <div>
      <p class="text-sm text-slate-500 uppercase tracking-wide">Panel admin</p>
      <h1 class="mt-2 text-3xl font-semibold tracking-tight">Powiadomienia</h1>
      <p class="mt-3 text-slate-600">
        Lista zgłoszeń z formularza kontaktowego. Kliknij adres e‑mail lub numer telefonu, aby skontaktować się z klientem.
      </p>
    </div>
    <div class="flex gap-2 flex-wrap">
      <a href="{{ url_for('admin_dashboard') }}" class="px-4 py-2 rounded-xl border border-slate-200 text-sm">← Gabinety</a>
      <a href="{{ url_for('index') }}#kontakt" class="px-4 py-2 rounded-xl border border-slate-200 text-sm">Formularz</a>
    </div>
  </div>

  <form class="mt-6 flex flex-col sm:flex-row gap-3" method="get" action="{{ url_for('admin_notifications') }}">
    <input name="q" value="{{ q }}" placeholder="Szukaj (imię, email, telefon, tekst)" class="flex-1 px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
    <button class="px-5 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800 w-full sm:w-auto">Szukaj</button>
  </form>

  {% if total is not none %}
    <div class="mt-3 text-sm text-slate-500">Łącznie: {{ total }}{% if q %} (filtr: “{{ q }}”){% endif %}</div>
  {% endif %}
</section>

<section class="max-w-6xl mx-auto px-4 pb-16">
  {# Mobile-first cards #}
  <div class="admin-notifications-cards">
    <div class="grid gap-3">
      {% for l in leads %}
        <article class="rounded-3xl border border-slate-100 bg-white p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="text-sm">
              <div class="text-slate-500">#{{ l.id }} · <span class="font-mono">{{ l.created_at }}</span></div>
              <div class="mt-1 font-semibold text-slate-900">{{ l.name or '—' }}</div>
            </div>
          </div>

          <div class="mt-3 text-sm text-slate-700">
            <div>
              E‑mail:
              {% if l.email %}
                <a class="underline" href="mailto:{{ l.email }}">{{ l.email }}</a>
              {% else %}
                —
              {% endif %}
            </div>
            <div class="mt-1">
              Tel:
              {% if l.phone %}
                <a class="underline" href="tel:{{ (l.phone or '')|replace(' ','') }}">{{ l.phone }}</a>
              {% else %}
                —
              {% endif %}
            </div>
          </div>

          <details class="mt-3">
            <summary class="cursor-pointer text-sm font-medium text-slate-800">Treść</summary>
            <div class="mt-2 lead-message">{{ l.message or '—' }}</div>
          </details>
        </article>
      {% endfor %}

      {% if not leads %}
        <div class="rounded-3xl border border-slate-100 bg-white p-6 text-slate-600">Brak zgłoszeń.</div>
      {% endif %}
    </div>
  </div>

  {# Desktop table #}
  <div class="rounded-3xl border border-slate-100 overflow-hidden admin-notifications-table-wrap">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm admin-notifications-table">
        <thead class="bg-slate-50 text-slate-600">
          <tr class="[&>th]:text-left [&>th]:font-semibold [&>th]:px-4 [&>th]:py-3">
            <th class="w-20">ID</th>
            <th class="w-44">Czas (UTC)</th>
            <th class="w-56">Klient</th>
            <th class="w-60">Kontakt</th>
            <th>Treść</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for l in leads %}
            <tr class="[&>td]:px-4 [&>td]:py-3 align-top">
              <td class="text-slate-500">#{{ l.id }}</td>
              <td class="text-slate-600 font-mono">{{ l.created_at }}</td>
              <td>
                <div class="font-semibold text-slate-900">{{ l.name or '—' }}</div>
              </td>
              <td class="text-slate-700 admin-notifications-contact">
                {% if l.email %}
                  <div>E‑mail: <a class="underline" href="mailto:{{ l.email }}">{{ l.email }}</a></div>
                {% else %}
                  <div>E‑mail: —</div>
                {% endif %}
                {% if l.phone %}
                  <div class="mt-1">Tel: <a class="underline" href="tel:{{ (l.phone or '')|replace(' ','') }}">{{ l.phone }}</a></div>
                {% else %}
                  <div class="mt-1">Tel: —</div>
                {% endif %}
              </td>
              <td class="text-slate-800">
                <div class="flex items-start gap-3">
                  <div class="text-slate-600 admin-notifications-snippet">
                    {{ (l.message or '—')|truncate(90, True, '…') }}
                  </div>
                  <a href="#" class="underline text-slate-700 lead-toggle shrink-0" data-target="leadmsg-{{ l.id }}" aria-expanded="false">Podgląd</a>
                </div>
              </td>
            </tr>

            <tr id="leadmsg-{{ l.id }}" class="hidden admin-notifications-message-row">
              <td colspan="5" class="px-4 py-4">
                <div class="lead-message">{{ l.message or '—' }}</div>
              </td>
            </tr>
          {% endfor %}
          {% if not leads %}
            <tr><td colspan="5" class="px-4 py-8 text-slate-600">Brak zgłoszeń.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {% if total_pages and total_pages > 1 %}
    <div class="mt-6 flex flex-col sm:flex-row sm:items-center justify-between gap-3 text-sm">
      <div class="text-slate-600">Strona {{ page }} z {{ total_pages }}</div>
      <div class="flex flex-col sm:flex-row gap-2">
        {% if page > 1 %}
          <a class="px-4 py-2 rounded-xl border border-slate-200 hover:border-slate-300 w-full sm:w-auto text-center" href="{{ url_for('admin_notifications', page=page-1, q=q) }}">← Poprzednia</a>
        {% endif %}
        {% if page < total_pages %}
          <a class="px-4 py-2 rounded-xl border border-slate-200 hover:border-slate-300 w-full sm:w-auto text-center" href="{{ url_for('admin_notifications', page=page+1, q=q) }}">Następna →</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</section>
{% endblock %}
