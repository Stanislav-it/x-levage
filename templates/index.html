{% extends "base.html" %}
{% set title = BRAND ~ " — strona produktowa" %}

{% block head %}
  {{ super() }}
  <link rel="preload" as="video" href="{{ url_for('static', filename='video/hero_ios.mp4') }}" type="video/mp4">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block content %}
<!-- Fullscreen video hero (Neuralink-like) -->
<section class="relative h-[calc(100vh-64px)] min-h-[640px] overflow-hidden">
   pointer-events-none autoplay loop playsinline muted webkit-playsinline preload="auto" disablepictureinpicture controlslist="nodownload noplaybackrate noremoteplayback">
    <source src="{{ url_for('static', filename='video/hero_ios.mp4') }}" type="video/mp4" />
  </video>
  <div class="absolute inset-0 bg-gradient-to-b from-black/55 via-black/30 to-white/0"></div>

  <div class="relative max-w-6xl mx-auto px-4 h-full">
    <div class="h-full flex items-end pb-14">
      <div class="max-w-2xl">
        <p class="text-white/80 text-sm uppercase tracking-wide">Nowoczesne lasery frakcyjne</p>
        <h1 class="mt-3 text-4xl sm:text-6xl font-semibold tracking-tight text-white">
          X‑Levage Pro i X‑Levage Erbo
        </h1>
        <p class="mt-5 text-white/85 leading-relaxed text-base sm:text-lg">
          Technologia, materiały katalogowe, efekty oraz mapa autoryzowanych gabinetów.
        </p>

        <div class="mt-7 flex flex-col sm:flex-row gap-3">
          <a href="{{ url_for('pro') }}" class="px-6 py-3 rounded-2xl bg-white text-slate-900 hover:bg-white/90 shadow-soft">Poznaj X‑Levage Pro</a>
          <a href="{{ url_for('erbo') }}" class="px-6 py-3 rounded-2xl border border-white/60 text-white hover:bg-white/10">Poznaj X‑Levage Erbo</a>
          <button id="soundToggle" type="button" class="px-6 py-3 rounded-2xl border border-white/60 text-white hover:bg-white/10">Włącz dźwięk</button>
        </div>

        <div class="mt-6 flex items-center gap-3 text-white/75 text-sm">
          <button type="button" id="scrollNext" class="inline-flex items-center gap-2 hover:text-white">
            <span>Zobacz więcej</span>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14" /><path d="M19 12l-7 7-7-7" />
            </svg>
          </button>
          <span class="text-white/50">•</span>
          <span>{{ stats.pro_wavelength }} / {{ stats.erbo_wavelength }}</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Content starts here -->
<section id="start" class="max-w-6xl mx-auto px-4 pt-10 pb-12 scroll-mt-24">
  <div>
    <h2 class="text-2xl font-semibold tracking-tight">Szybki opis</h2>
    <p class="mt-3 text-slate-600 leading-relaxed max-w-3xl">
      Dwie konfiguracje technologii: laser tulowy 1927 nm oraz laser erbowo‑szklany 1550 nm + tulowy 1927 nm.
      Poniżej: efekty, zdjęcia urządzeń, mapa gabinetów oraz kontakt.
    </p>
  </div>

  <div class="mt-7 grid lg:grid-cols-2 gap-10 items-stretch">
    <!-- Prezentacja -->
    <div class="rounded-3xl border border-slate-100 p-6 shadow-soft bg-white flex flex-col h-full">
      <div>
        <div class="text-sm uppercase tracking-wide text-slate-500">Bezpłatna prezentacja</div>
        <div class="mt-2 text-xl font-semibold tracking-tight text-slate-900">Umów prezentację urządzenia X‑Levage</div>
        <p class="mt-3 text-slate-600 leading-relaxed">
          Wypełnij formularz, a skontaktujemy się w celu ustalenia terminu oraz miejsca prezentacji.
          Prezentacja jest bezpłatna.
        </p>
      </div>
      <div class="mt-auto pt-5 flex flex-col sm:flex-row gap-3">
        <a href="{{ url_for('prezentacja') }}" class="no-underline inline-flex items-center justify-center px-6 py-3 rounded-2xl bg-black text-white hover:bg-slate-900">
          Umów prezentację
        </a>
        <a href="{{ url_for('gabinet') }}" class="no-underline inline-flex items-center justify-center px-6 py-3 rounded-2xl border border-black text-black hover:bg-slate-50">
          Zobacz gabinety
        </a>
      </div>
    </div>

    <!-- Kontakt -->
    <div class="rounded-3xl border border-slate-100 p-6 shadow-soft bg-white flex flex-col h-full">
      <div class="text-sm text-slate-500">Szybki kontakt</div>
      <div class="mt-2 text-xl font-semibold">Zapytanie o urządzenie / prezentację</div>
      <form class="mt-5 grid gap-3" method="post" action="{{ url_for('lead') }}">
        <div class="grid sm:grid-cols-2 gap-3">
          <input name="name" placeholder="Imię i nazwisko" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
          <input name="phone" placeholder="Telefon (opcjonalnie)" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
        </div>
        <input type="email" name="email" placeholder="E‑mail" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
        <textarea name="message" rows="4" placeholder="Wiadomość" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200"></textarea>
        <button class="px-5 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">Wyślij</button>
        <p class="text-xs text-slate-500">
          Wysyłając formularz akceptujesz politykę prywatności.
        </p>
      </form>
    </div>
  </div>
</section>


<section id="efekty" class="max-w-6xl mx-auto px-4 py-12 scroll-mt-24" data-effects-gallery data-initial="8" data-step="8">
  <div class="flex items-end justify-between gap-6">
    <div>
      <div class="flex items-center gap-3">
        <h2 class="text-2xl font-semibold tracking-tight">Efekty zabiegów</h2>
        {% if effects %}
          <span class="inline-flex items-center rounded-full border border-slate-200 bg-white px-3 py-1 text-xs text-slate-600">
            {{ effects|length }} zdjęć
          </span>
        {% endif %}
      </div>
      <p class="mt-2 text-slate-600">Wybrane rezultaty zabiegów – dokumentacja przed/po.</p>
    </div>
    <a href="{{ url_for('pro') }}#efekty" class="text-sm underline text-slate-600 hover:text-slate-900">Zobacz opis technologii</a>
  </div>

  {% if effects %}
    <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3" data-effects-grid>
      {% for src in effects %}
        <a href="{{ src }}" target="_blank" data-effects-item
           class="group block overflow-hidden rounded-2xl border border-slate-100 bg-slate-50 {% if loop.index0 >= 8 %}hidden{% endif %}">
          <img src="{{ src }}" alt="Efekt zabiegu" loading="lazy" class="w-full h-48 object-cover group-hover:scale-[1.02] transition">
        </a>
      {% endfor %}
    </div>

    {% if effects|length > 8 %}
      <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="text-sm text-slate-600">
          Pokazano <span class="font-semibold text-slate-900" data-effects-shown>8</span>
          z <span class="font-semibold text-slate-900" data-effects-total>{{ effects|length }}</span>
        </div>
        <button type="button" class="inline-flex items-center justify-center px-5 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800" data-effects-more>
          Pokaż więcej
        </button>
      </div>
    {% endif %}
  {% else %}
    <div class="mt-6 rounded-2xl border border-dashed border-slate-200 p-8 text-slate-600">
      Brak zdjęć do wyświetlenia.
    </div>
  {% endif %}
</section>

<section id="urzadzenia" class="max-w-6xl mx-auto px-4 py-12 scroll-mt-24">
  <div class="flex items-end justify-between gap-6">
    <div>
      <h2 class="text-2xl font-semibold tracking-tight">Zdjęcia urządzeń</h2>
      <p class="mt-2 text-slate-600">Galeria urządzeń i zastosowań w gabinecie.</p>
    </div>
  </div>

  {% if devices %}
    <div class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-3">
      {% for src in devices %}
        <a href="{{ src }}" target="_blank" class="group block overflow-hidden rounded-2xl border border-slate-100 bg-slate-50">
          <img src="{{ src }}" alt="Zdjęcie urządzenia" class="w-full h-56 object-cover group-hover:scale-[1.02] transition">
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="mt-6 rounded-2xl border border-dashed border-slate-200 p-8 text-slate-600">
      Brak zdjęć do wyświetlenia.
    </div>
  {% endif %}
</section>

<section id="mapa" class="max-w-6xl mx-auto px-0 sm:px-4 py-12 scroll-mt-24">
  <div class="rounded-none sm:rounded-3xl border-0 sm:border border-slate-100 p-0 sm:p-8 shadow-soft bg-white">
    
    <div class="px-4 sm:px-0">
      <h2 class="text-2xl font-semibold tracking-tight">Mapa gabinetów</h2>
      <p class="mt-2 text-slate-600">Wybierz gabinet z listy lub kliknij punkt na mapie.</p>
    </div>
    <div class="mt-5 grid md:grid-cols-2 gap-6 sm:gap-10 items-start">
      <div class="order-2 md:order-1 px-0">
        <div class="rounded-none sm:rounded-2xl border-0 sm:border border-slate-200 bg-white overflow-hidden">
	          <div class="px-4 py-3 sm:p-4 border-b border-slate-100 flex items-center justify-between">
	            <div class="text-sm font-semibold">Lista gabinetów</div>
	            <a href="{{ url_for('gabinet') }}" class="text-xs text-slate-900 underline decoration-slate-300 hover:decoration-slate-500">Otwórz pełną mapę</a>
	          </div>
	          <div id="mapPreviewList" class="map-preview-list"></div>
	        </div>
      </div>
      <div class="order-1 md:order-2 rounded-none sm:rounded-2xl border-0 sm:border border-slate-200 bg-white overflow-hidden">
        <div class="px-4 py-3 sm:p-4 border-b border-slate-100 flex items-center justify-between">
          <div class="text-sm font-semibold">Mapa</div>
          <div class="text-xs text-slate-500">OpenStreetMap</div>
        </div>
        <div id="mapPreview" class="map-preview"></div>
      </div>
    </div>
  </div>
</section>

<section id="kontakt" class="max-w-6xl mx-auto px-4 py-12 scroll-mt-24">
  <div class="grid md:grid-cols-2 gap-10">
    <div>
      <h2 class="text-2xl font-semibold tracking-tight">Kontakt</h2>
      <p class="mt-2 text-slate-600">
        Jeśli potrzebujesz materiałów wideo lub dodatkowych zdjęć — wyślij wiadomość.
      </p>
      <div class="mt-6 space-y-2 text-sm text-slate-700">
        {% if CONTACT_PHONE %}<div>Telefon/WhatsApp: <a class="underline" href="tel:{{ CONTACT_PHONE|replace(' ','') }}">{{ CONTACT_PHONE }}</a></div>{% endif %}
        {% if CONTACT_EMAIL %}<div>E‑mail: <a class="underline" href="mailto:{{ CONTACT_EMAIL }}">{{ CONTACT_EMAIL }}</a></div>{% endif %}
        {% if FACEBOOK_URL %}<div>Facebook: <a class="underline" href="{{ FACEBOOK_URL }}" target="_blank" rel="noopener">/lasertulowyxlevage</a></div>{% endif %}
      </div>
    </div>
    <div class="rounded-3xl border border-slate-100 p-6 shadow-soft">
      <div class="text-sm text-slate-500">Szybkie zapytanie</div>
      <form class="mt-4 grid gap-3" method="post" action="{{ url_for('lead') }}">
        <input name="name" placeholder="Imię i nazwisko" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
        <div class="grid sm:grid-cols-2 gap-3">
          <input type="email" name="email" placeholder="E‑mail" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
          <input name="phone" placeholder="Telefon" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200">
        </div>
        <textarea name="message" rows="4" placeholder="Wiadomość" class="w-full px-4 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-200"></textarea>
        <button class="px-5 py-3 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">Wyślij</button>
      </form>
    </div>
  </div>
</section>

{% block scripts %}
  {{ super() }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    (function () {
      const el = document.getElementById('mapPreview');
      if (!el || typeof L === 'undefined') return;

      // Init map
      const map = L.map(el, { scrollWheelZoom: false, dragging: true, tap: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const icon = L.icon({
        iconUrl: '{{ url_for('static', filename='img/marker.svg') }}',
        iconSize: [26, 26],
        iconAnchor: [13, 26],
        popupAnchor: [0, -22]
      });

      // Default view (Poland)
      map.setView([52.1, 19.4], 6);

      fetch('{{ url_for('api_clinics') }}?view=all')
        .then(r => r.json())
        .then(data => {
          const clinics = (data && data.clinics) ? data.clinics : [];
          const listEl = document.getElementById('mapPreviewList');
          const markerById = new Map();
          const pts = [];

          // Sort for nicer left list
          clinics.sort((a, b) => (String(a.city || '') + String(a.name || '')).localeCompare(String(b.city || '') + String(b.name || ''), 'pl'));

          clinics.forEach((c, idx) => {
            if (!c || c.lat == null || c.lon == null) return;
            const lat = parseFloat(c.lat);
            const lng = parseFloat(c.lon);
            if (!isFinite(lat) || !isFinite(lng)) return;
            pts.push([lat, lng]);

            const title = (c.name || 'Gabinet').trim();
            const city = (c.city || '').trim();
            const address = (c.address || '').trim();
            const phone = (c.phone || '').trim();

            // Marker + popup
            const popupParts = [];
            popupParts.push('<div class="text-sm font-semibold">' + title + (city ? (' — ' + city) : '') + '</div>');
            if (address) popupParts.push('<div class="text-xs text-slate-600">' + address + '</div>');
            if (phone) popupParts.push('<div class="mt-2 text-sm"><a class="underline" href="tel:' + phone.replace(/\s+/g,'') + '">' + phone + '</a></div>');
            const m = L.marker([lat, lng], { icon }).addTo(map).bindPopup(popupParts.join(''));
            if (c.id != null) markerById.set(String(c.id), m);

            // Left list
            if (listEl) {
              let badge = (c.kind === 'ambassadors') ? 'Ambasadorski' : 'Autoryzowany';
              if (title.toLowerCase().includes('showroom')) badge = 'Showroom';

              const row = document.createElement('button');
              row.type = 'button';
              row.className = 'mpl-item';
              const n = idx + 1;
              row.innerHTML =
                '<div class="mpl-top">'
                  + '<div class="mpl-left">'
                    + '<div class="mpl-num">' + n + '.</div>'
                    + '<div class="mpl-name">' + title + '</div>'
                  + '</div>'
                  + '<div class="mpl-badge">' + badge + '</div>'
                + '</div>'
                + (address ? ('<div class="mpl-addr">' + address + '</div>') : '')
                + (phone ? ('<div class="mpl-phone"><a href="tel:' + phone.replace(/\s+/g,'') + '" onclick="event.stopPropagation()">' + phone + '</a></div>') : '');
              row.addEventListener('click', () => {
                map.setView([lat, lng], Math.max(map.getZoom(), 12), { animate: true });
                m.openPopup();
              });
              listEl.appendChild(row);
            }
          });
          if (pts.length) {
            const bounds = L.latLngBounds(pts).pad(0.15);
            map.fitBounds(bounds);
          }
        })
        .catch(() => {
          // keep default view
        });
    })();
  </script>
{% endblock %}
{% endblock %}
